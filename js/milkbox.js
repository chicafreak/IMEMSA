(function(){var b=null;this.Milkbox=new Class({Implements:[Options,Events],options:{overlayOpacity:0.55,marginTop:50,initialWidth:200,initialHeight:200,fileboxBorderWidth:"0px",fileboxBorderColor:"#000000",fileboxPadding:"0px",resizeDuration:0.5,resizeTransition:"sine:in:out",autoPlay:false,autoPlayDelay:7,removeTitle:true,autoSize:true,autoSizeMaxHeight:0,centered:false,imageOfText:"of",onXmlGalleries:function(){},onClosed:function(){},onFileReady:function(){}},initialize:function(a){if(b){return b}b=this;this.setOptions(a);this.autoPlayBkup={autoPlayDelay:this.options.autoPlayDelay,autoPlay:this.options.autoPlay};this.fullOptionsBkup={};this.galleries=[];this.formElements=[];this.activated;this.busy=false;this.paused=false;this.closed=true;this.intId;this.loadCheckerId;this.externalGalleries=[];this.singlePageLinkId=0;this.currentIndex;this.currentGallery;this.fileReady;this.loadedImages=[];this.currentFile;this.options_bkup;this.display;this.getPageGalleries();if(this.galleries.length!=0){this.prepare(true)}},prepare:function(a){if(a){this.checkFormElements()}this.prepareHTML();this.prepareEventListeners();this.activated=true},open:function(a,j){var i;if(!this.activated){this.prepare(true)}var g=(instanceOf(a,MilkboxGallery))?a:this.getGallery(a);if(!g){return false}if(typeOf(j)!=="number"){i=g.get_index_of(j);if(i!==-1){j=i}}i=parseInt(j,10);if(isNaN(i)){i=0}this.closed=false;var h=g.get_item(i);if(!h){return false}this.currentGallery=g;this.currentIndex=i;this.hideFormElements();this.display.set_mode(this.currentGallery.type);this.display.appear();if(this.options.autoPlay||g.options.autoplay){this.startAutoPlay(true)}this.loadFile(h,this.getPreloads());return true},close:function(a){if(a){this.display.disappear()}this.showFormElements();this.pauseAutoPlay();this.stopLoadingCheck();this.currentGallery=null;this.currentIndex=null;this.currentFile=null;this.busy=false;this.paused=false;this.fileReady=false;this.closed=true;this.fireEvent("close")},startAutoPlay:function(a){var d=this.currentGallery.options.autoplay_delay||this.options.autoPlayDelay;if(d<this.options.resizeDuration*2){d=this.options.resizeDuration*2}var f=function(){this.removeEvent("fileReady",f);this.intId=this.navAux.periodical(d*1000,this,[null,"next"])};if(a){this.addEvent("fileReady",f)}else{this.intId=this.navAux.periodical(d*1000,this,[null,"next"])}this.paused=false},pauseAutoPlay:function(){if(this.intId){clearInterval(this.intId);this.intId=null}this.paused=true},setAutoPlay:function(d){var a=(typeOf(d)=="object")?[d]:d;a.each(function(g){var j=this.getGallery(g.gallery);if(!j){return}var k=(g.autoplay==true)?g.autoplay:false;var c=(g.delay&&k)?g.delay:this.options.autoPlayDelay;j.setOptions({autoplay:k,autoplay_delay:c}).refresh()},this)},openWithFile:function(f,a){if(!this.activated){this.prepare()}if(a){this.refreshDisplay(a,true)}var e=new MilkboxGallery([f]);this.open(e,0)},getPreloads:function(){var a=this.currentGallery.items;var j=this.currentIndex;if(a.length==1){return null}var h=(j!=a.length-1)?a[j+1]:a[0];var g=(j!=0)?a[j-1]:a[a.length-1];var i=(g==h)?[g]:[g,h];return i},loadFile:function(d,a){this.fileReady=false;this.display.clear_content();this.display.hide_bottom();if(this.checkFileType(d,"swf")){this.loadSwf(d)}else{if(this.checkFileType(d,"html")||this.checkFileType(d,"php")){this.loadHtml(d)}else{this.loadImage(d)}}if(!this.checkFileType(d,"swf")){this.startLoadingCheck()}if(a){this.preloadFiles(a)}},startLoadingCheck:function(){var a=0;if(!this.loadCheckerId){this.loadCheckerId=(function(){a+=1;if(a>5){if(this.loadCheckerId){this.display.show_loader()}this.stopLoadingCheck()}}).periodical(100,this)}},stopLoadingCheck:function(){clearInterval(this.loadCheckerId)},preloadFiles:function(a){a.each(function(e,f){if(!this.checkFileType(e,"swf")&&!this.checkFileType(e,"html")){this.preloadImage(e.href)}},this)},preloadImage:function(d){if(!this.loadedImages.contains(d)){var a=new Asset.image(d,{onLoad:function(){this.loadedImages.push(d)}.bind(this)})}},loadImage:function(e){var f=e.href;var a=new Asset.image(f,{onLoad:function(c){if(!this.loadedImages.contains(f)){this.loadedImages.push(f)}this.loadComplete(c,e.caption)}.bind(this)})},loadSwf:function(d){var a=new Swiff(d.href,{width:d.size.width,height:d.size.height,vars:d.vars,params:{wMode:"opaque",swLiveConnect:"false"}});this.loadComplete($(a),d.caption)},loadHtml:function(f){var e=(f.vars?"?"+Object.toQueryString(f.vars):"");var a=new Element("iframe",{id:"idata",src:f.href+e,frameborder:0,scrolling:"no",styles:{border:"none"}});if(f.size){a.set({width:f.size.width,height:f.size.height})}this.loadComplete(a,f.caption)},loadComplete:function(f,a){if(this.closed){return}this.fileReady=true;this.stopLoadingCheck();this.currentFile=f;var e;e=(function(){if(this.display.ready){if(this.currentGallery.items!=null){this.display.show_file(f,a,this.currentIndex+1,this.currentGallery.items.length)}clearInterval(e)}}).periodical(100,this);this.fireEvent("fileReady")},checkFileType:function(h,g){var a=(typeOf(h)!="string")?h.href:h;var f=new RegExp(".("+g+")$","i");return a.split("?")[0].test(f)},getPageGalleries:function(){var d=[];var a=$$("a[data-milkbox]");a.each(function(c){var f=c.get("data-milkbox");if(f=="single"){this.galleries.push(new MilkboxGallery(c,{name:"single"+this.singlePageLinkId++}))}else{if(!d.contains(f)){d.push(f)}}},this);d.each(function(c){this.galleries.push(new MilkboxGallery($$("a[data-milkbox="+c+"]"),{name:c}))},this);if(this.options.autoPlay){this.galleries.each(function(c){c.setOptions({autoplay:this.options.autoPlay,autoplay_delay:this.options.autoPlayDelay})})}},reloadPageGalleries:function(){this.removePageGalleryEvents();this.galleries=this.galleries.filter(function(a){if(!a.external){a.clear()}return a.external});this.getPageGalleries();this.addPageGalleriesEvents();if(!this.activated){this.prepare(true)}},resetExternalGalleries:function(a){this.galleries=this.galleries.filter(function(c){if(c.external){c.clear()}return!c.external});if(!a){return}var d=(typeOf(a)=="array")?a:[a];d.each(function(c){this.addGalleries(c)},this)},addGalleries:function(a){if(!this.activated){this.prepare(true)}if(typeOf(a)=="string"&&a.split("?")[0].test(/\.(xml)$/i)){this.loadXml(a)}else{this.setObjectGalleries(a)}if(!this.activated){this.prepare(true)}},loadXml:function(a){var d=new Request({method:"get",autoCancel:true,url:a,onRequest:function(){}.bind(this),onSuccess:function(c,h){var g=c.replace(/(<a.+)\/>/gi,"$1></a>");this.setXmlGalleries(new Element("div",{html:g}))}.bind(this),onFailure:function(c){alert("Milkbox :: loadXml: XML file path error or local Ajax test: please test xml galleries on-line")}}).send()},setXmlGalleries:function(i){var c=i;var a=c.getElements(".gallery");var h;var j=[];a.each(function(d,e){var f={name:d.getProperty("name"),autoplay:Boolean(d.getProperty("autoplay")),autoplay_delay:Number(d.getProperty("autoplay_delay"))};var g=d.getChildren("a").map(function(k){return{href:k.href,size:k.get("data-milkbox-size"),title:k.get("title")}},this);this.galleries.push(new MilkboxGallery(g,f))},this);this.fireEvent("xmlGalleries")},setObjectGalleries:function(a){var d=(typeOf(a)=="array")?a:[a];d.each(function(c){var f={name:c.name,autoplay:c.autoplay,autoplay_delay:c.autoplay_delay};this.galleries.push(new MilkboxGallery(c.files,f))},this)},getGallery:function(a){var d=this.galleries.filter(function(c){return c.name==a},this);return d[0]||null},prepareHTML:function(){this.display=new MilkboxDisplay({initialWidth:this.options.initialWidth,initialHeight:this.options.initialHeight,overlayOpacity:this.options.overlayOpacity,marginTop:this.options.marginTop,fileboxBorderWidth:this.options.fileboxBorderWidth,fileboxBorderColor:this.options.fileboxBorderColor,fileboxPadding:this.options.fileboxPadding,resizeDuration:this.options.resizeDuration,resizeTransition:this.options.resizeTransition,centered:this.options.centered,autoSize:this.options.autoSize,autoSizeMaxHeight:this.options.autoSizeMaxHeight,imageOfText:this.options.imageOfText})},refreshDisplay:function(g,h){if(!this.activated){return}var a=this.display.options;var f=Object.merge({},a,g);if(this.display){this.display.clear()}this.display=new MilkboxDisplay(f);this.addDisplayEvents();if(h){this.options_bkup=a}else{this.options_bkup=null}},checkFormElements:function(){this.formElements=$$("select, textarea");if(this.formElements.length==0){return}this.formElements=this.formElements.map(function(a){a.store("visibility",a.getStyle("visibility"));a.store("display",a.getStyle("display"));return a})},hideFormElements:function(){if(this.formElements.length==0){return}this.formElements.each(function(a){a.setStyle("display","none")})},showFormElements:function(){if(this.formElements.length==0){return}this.formElements.each(function(a){a.setStyle("visibility",a.retrieve("visibility"));a.setStyle("display",a.retrieve("display"))})},addPageGalleriesEvents:function(){var a=this.galleries.filter(function(d){return!d.external});a.each(function(d){d.items.each(function(c){c.element.addEvent("click",function(e){e.preventDefault();this.open(d.name,d.get_index_of(c))}.bind(this))},this)},this)},removePageGalleryEvents:function(){var a=this.galleries.filter(function(d){return!d.external});a.each(function(d){d.items.each(function(c){c.element.removeEvents("click")})})},addDisplayEvents:function(){this.display.addEvent("nextClick",function(){this.navAux(true,"next")}.bind(this));this.display.addEvent("prevClick",function(){this.navAux(true,"prev")}.bind(this));this.display.addEvent("playPauseClick",function(){if(this.paused){this.startAutoPlay()}else{this.pauseAutoPlay()}this.display.set_paused(this.paused)}.bind(this));this.display.addEvent("disappear",function(){if(this.options_bkup){this.refreshDisplay(this.options_bkup)}this.close(false)}.bind(this));this.display.addEvent("resizeComplete",function(){this.busy=false}.bind(this))},prepareEventListeners:function(){this.addPageGalleriesEvents();this.addDisplayEvents();window.addEvent("resize",function(){if(this.display.ready){this.display.resetOverlaySize()}}.bind(this));window.document.addEvent("keydown",function(a){if(this.busy==true||this.closed){return}if(a.key=="right"||a.key=="left"||a.key=="space"){a.preventDefault()}if(this.display.mode!="single"){if(a.key=="right"||a.key=="space"){this.navAux(a,"next")}else{if(a.key=="left"){this.navAux(a,"prev")}}}if(a.key=="esc"){this.display.disappear()}}.bind(this))},navAux:function(e,g){if(e){this.pauseAutoPlay()}else{if(this.busy||!this.fileReady){return}}this.busy=true;var a,h;if(g=="next"){a=(this.currentIndex!=this.currentGallery.items.length-1)?this.currentIndex+=1:this.currentIndex=0;h=(this.currentIndex!=this.currentGallery.items.length-1)?this.currentIndex+1:0}else{a=(this.currentIndex!=0)?this.currentIndex-=1:this.currentIndex=this.currentGallery.items.length-1;h=(this.currentIndex!=0)?this.currentIndex-1:this.currentGallery.items.length-1}this.loadFile(this.currentGallery.get_item(a),[this.currentGallery.get_item(h)])}})})();var MilkboxDisplay=new Class({Implements:[Options,Events],options:{initialWidth:100,initialHeight:100,overlayOpacity:1,marginTop:0,fileboxBorderWidth:"0px",fileboxBorderColor:"#000000",fileboxPadding:"0px",resizeDuration:0.5,resizeTransition:"sine:in:out",centered:false,autoSize:false,autoSizeMaxHeight:0,imageOfText:"of",onNextClick:function(){},onPrevClick:function(){},onPlayPause:function(){},onDisappear:function(){},onResizeComplete:function(){}},initialize:function(b){this.setOptions(b);this.overlay;this.mainbox;this.filebox;this.bottom;this.controls;this.caption;this.close;this.next;this.prev;this.playpause;this.paused=false;this.count;this.mode="standard";this.ready=false;this.overlay_show_fx;this.overlay_hide_fx;this.mainbox_show_fx;this.mainbox_hide_fx;this.mainbox_resize_fx;this.current_file=null;this.build_html();this.prepare_effects();this.prepare_events()},build_html:function(){this.overlay=new Element("div",{id:"mbox-overlay",styles:{visibility:"visible",position:"fixed",display:"none",left:0,width:"100%",opacity:0,height:0,overflow:"hidden",margin:0,padding:0}}).inject($(document.body));this.mainbox=new Element("div",{id:"mbox-mainbox",styles:{position:(this.options.centered)?"fixed":"absolute",overflow:"hidden",display:"none","z-index":50001,width:this.options.initialWidth,height:this.options.initialHeight-10+"px",opacity:0,margin:0,left:"50%",marginLeft:-(this.options.initialWidth/2),marginTop:(this.options.centered)?-(this.options.initialHeight/2):"",top:(this.options.centered)?"50%":""}}).inject($(document.body));this.filebox=new Element("div",{id:"mbox-filebox",styles:{"border-style":"solid","border-width":this.options.fileboxBorderWidth,"border-color":this.options.fileboxBorderColor,padding:this.options.fileboxPadding,opacity:0}}).inject(this.mainbox);this.bottom=new Element("div#mbox-bottom").setStyle("visibility","hidden").inject(this.mainbox);this.controls=new Element("div#mbox-controls");this.caption=new Element("div#mbox-caption",{html:"test"}).setStyle("display","none");this.bottom.adopt(new Element("div.mbox-reset"),this.controls,this.caption,new Element("div.mbox-reset"));this.close=new Element("div#mbox-close");this.next=new Element("div#mbox-next");this.prev=new Element("div#mbox-prev");this.playpause=new Element("div#mbox-playpause");this.count=new Element("div#mbox-count");$$(this.next,this.prev,this.close,this.playpause).setStyles({outline:"none",cursor:"pointer"});this.controls.adopt(new Element("div.mbox-reset"),this.close,this.next,this.prev,this.playpause,new Element("div.mbox-reset"),this.count)},prepare_effects:function(){this.overlay_show_fx=new Fx.Tween(this.overlay,{duration:"short",link:"cancel",property:"opacity",onStart:function(){this.element.setStyles({top:-window.getScroll().y,height:window.getScrollSize().y+window.getScroll().y,display:"block"})},onComplete:function(){this.mainbox_show_fx.start(1)}.bind(this)});this.overlay_hide_fx=new Fx.Tween(this.overlay,{duration:"short",link:"cancel",property:"opacity",onStart:function(){},onComplete:function(){this.overlay.setStyle("display","none");this.fireEvent("disappear")}.bind(this)});this.mainbox_show_fx=new Fx.Tween(this.mainbox,{duration:"short",link:"cancel",property:"opacity",onStart:function(){this.mainbox.setStyle("display","block")}.bind(this),onComplete:function(){this.ready=true}.bind(this)});this.mainbox_hide_fx=new Fx.Tween(this.mainbox,{duration:"short",link:"cancel",property:"opacity",onStart:function(){this.ready=false}.bind(this),onComplete:function(){this.overlay.setStyle("display","none")}.bind(this)});this.mainbox_resize_fx=new Fx.Morph(this.mainbox,{duration:this.options.resizeDuration*1000,transition:this.options.resizeTransition,link:"cancel",onStart:function(){this.filebox.setStyle("opacity",0)}.bind(this),onComplete:function(){this.show_bottom();this.filebox.setStyle("height",this.current_file.height+"px");this.filebox.grab(this.current_file).tween("opacity",1);this.fireEvent("resizeComplete")}.bind(this)});this.filebox.set("tween",{duration:"short",link:"chain"})},prepare_events:function(){$$(this.overlay,this.close).addEvent("click",function(){this.disappear()}.bind(this));this.prev.addEvent("click",function(){this.fireEvent("prevClick")}.bind(this));this.next.addEvent("click",function(){this.fireEvent("nextClick")}.bind(this));this.playpause.addEvent("click",function(){this.fireEvent("playPauseClick")}.bind(this))},show_file:function(t,l,q,u){this.hide_loader();if(t.match&&t.match("img")&&(this.options.autoSize||this.options.centered)){var t=this.get_resized_image(t)}var p={w:t.width.toInt(),h:t.height.toInt()};if(!p.w||!p.h){alert("Milkbox error: you must pass size values if the file is swf or html or a free file (openWithFile)");return}p=Object.map(p,function(a){return a.toInt()});this.caption.innerHTML=(l)?l:"";this.update_count(q,u);var o=this.filebox.getStyle("border-width").toInt()*2+this.filebox.getStyle("padding").toInt()*2;var n=p.w+o;var m=this.caption.getStyles("paddingRight","marginRight");this.caption.setStyle("width",n-m.paddingRight.toInt()-m.marginRight.toInt());$$(this.bottom,this.controls).setStyle("height",Math.max(this.caption.getDimensions().height,this.controls.getComputedSize().totalHeight));var v=this.mainbox.getComputedSize();var r=p.h+o+this.bottom.getComputedSize().totalHeight;var s={w:n,h:r-5,total_w:n+v.totalWidth-v.width,total_h:r+v.totalHeight-v.height};this.current_file=t;this.resize_to(s)},get_resized_image:function(k){var l;var h;var i;var j={w:k.get("width").toInt(),h:k.get("height").toInt()};var n=window.getSize();var l={w:n.x-60,h:n.y-68-this.options.marginTop*2};var m=Math.max(l.h,l.w);if(m==l.w){h=m/j.w;i="h"}else{h=m/j.h;i="w"}h=(h<=1)?h:1;j=Object.map(j,function(a){return Math.floor(a*h)});h=(l[i]/j[i]<=1)?l[i]/j[i]:1;j=Object.map(j,function(a){return Math.floor(a*h)});if(this.options.autoSizeMaxHeight>0){h=(this.options.autoSizeMaxHeight/j.height<1)?this.options.autoSizeMaxHeight/j.height:1;j=Object.map(j,function(a){return Math.floor(a*h)})}k.set({width:j.w,height:j.h});return k},resize_to:function(b){this.mainbox_resize_fx.start({width:b.w,height:b.h,marginLeft:-(b.total_w/2).round(),marginTop:(this.options.centered)?-(b.total_h/2).round():""})},show_loader:function(){this.mainbox.addClass("mbox-loading")},hide_loader:function(){this.mainbox.removeClass("mbox-loading")},clear_content:function(){this.filebox.empty();this.caption.empty();this.count.empty();$$(this.bottom,this.controls).setStyle("height","")},hide_bottom:function(){this.caption.setStyle("display","none");this.bottom.setStyle("visibility","hidden")},show_bottom:function(){this.caption.setStyle("display","block");this.bottom.setStyle("visibility","visible")},appear:function(){if(!this.options.centered){this.mainbox.setStyle("top",window.getScroll().y+this.options.marginTop)}this.overlay_show_fx.start(this.options.overlayOpacity)},disappear:function(){this.cancel_effects();this.current_file=null;this.ready=false;this.mode="standard";$$(this.prev,this.next,this.playpause,this.count).setStyle("display","none");this.playpause.setStyle("backgroundPosition","0 0");this.count.empty();this.caption.setStyle("display","none").empty();this.bottom.setStyle("visibility","hidden");this.filebox.setStyle("height","").empty();this.mainbox.setStyles({opacity:0,display:"none",width:this.options.initialWidth,height:this.options.initialHeight,marginLeft:-(this.options.initialWidth/2),marginTop:(this.options.centered)?-(this.options.initialHeight/2):"",top:(this.options.centered)?"50%":""});this.filebox.setStyle("opacity",0);this.overlay_hide_fx.start(0)},cancel_effects:function(){[this.mainbox_resize_fx,this.mainbox_hide_fx,this.mainbox_show_fx,this.overlay_hide_fx,this.overlay_show_fx].each(function(b){b.cancel()})},set_mode:function(g){this.mode=g;var l=this.close.getComputedSize().width;var h=this.prev.getComputedSize().width;var k=this.next.getComputedSize().width;var i=this.playpause.getComputedSize().width;var j=this.mainbox.getStyle("border-right-width").toInt();switch(g){case"autoplay":$$(this.playpause,this.close,this.next,this.prev,this.count).setStyle("display","block");this.controls.setStyle("width",l+h+k+i+j);break;case"single":$$(this.playpause,this.next,this.prev,this.count).setStyle("display","none");this.controls.setStyle("width",l+j);break;case"standard":$$(this.close,this.next,this.prev,this.count).setStyle("display","block");this.playpause.setStyle("display","none");this.controls.setStyle("width",l+h+k+j);break;default:return}this.caption.setStyle("margin-right",this.controls.getComputedSize().totalWidth)},set_paused:function(d){this.paused=d;var c=(this.paused)?"0 -66px":"";this.playpause.setStyle("background-position",c)},update_count:function(d,c){this.count.set("text",d+" "+this.options.imageOfText+" "+c)},resetOverlaySize:function(){if(this.overlay.getStyle("opacity")==0){return}var b=window.getSize().y;this.overlay.setStyles({height:b})},clear:function(){this.overlay.destroy();this.mainbox.destroy()}});var MilkboxGallery=new Class({Implements:[Options,Events],options:{name:null,autoplay:null,autoplay_delay:null},initialize:function(c,d){this.setOptions(d);this.source=c;this.external=false;this.items=null;this.name=this.options.name;this.type=null;this.prepare_gallery();this.prepare_elements()},prepare_gallery:function(){switch(typeOf(this.source)){case"element":if(this.check_extension(this.source.href)){this.items=[this.source]}else{alert("Wrong file extension: "+this.source.href)}break;case"elements":this.items=this.source.filter(function(b){return this.check_extension(b.href)},this);break;case"array":this.items=this.source.filter(function(b){return this.check_extension(b.href)},this);this.external=true;break;default:return}if(this.items.length==0){alert("Warning: gallery "+this.name+" is empty")}},prepare_elements:function(){this.items=this.items.map(function(g){var e=g.href.split("?");var f={};f.element=(typeOf(g)=="element")?g:null;f.href=e[0];f.vars=(e[1])?e[1].parseQueryString():null;f.size=null;f.caption=(f.element)?f.element.get("title"):g.title;var h=(f.element)?f.element.get("data-milkbox-size"):g.size;if(h){f.size=Object.map(this.get_item_props(h),function(a,b){return a.toInt()})}return f},this);if(this.items.length==0){return}this.type=(this.items.length==1)?"single":(this.options.autoplay)?"autoplay":"standard"},check_extension:function(b){return b.split("?")[0].test(/\.(gif|jpg|jpeg|png|swf|html|php)$/i)},get_index_of:function(c){var d=(typeOf(c)=="string")?this.items.indexOf(this.items.filter(function(a){return a.href===c})[0]):this.items.indexOf(c);return this.items.indexOf(c)},get_item:function(b){return this.items[b]},get_item_props:function(e){var f={};var d=e.split(",").each(function(a,b){var c=a.trim().split(":");f[c[0].trim()]=c[1].trim()},this);return f},refresh:function(){this.type=(this.items.length==1)?"single":(this.options.autoplay)?"autoplay":"standard"},clear:function(){this.source=null;this.items=null}});window.addEvent("domready",function(){milkbox=new Milkbox({centered:true})});